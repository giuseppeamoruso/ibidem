<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Evento su Ibidem</title>
    
    <!-- Meta tags dinamici -->
    <meta name="description" content="Scopri questo evento su Ibidem" id="page-description">
    <meta property="og:title" content="Evento su Ibidem" id="og-title">
    <meta property="og:description" content="Scopri questo evento su Ibidem" id="og-description">
    <meta property="og:image" content="" id="og-image">
    <meta property="og:url" content="" id="og-url">
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="icon" href="../images/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="../">
                    <img src="../images/logo.png" alt="Ibidem Logo" class="nav-logo">
                    <span>Ibidem</span>
                </a>
            </div>
            <div class="nav-links">
                <a href="../#features">Funzionalit√†</a>
                <a href="../download.html">Download</a>
                <a href="../#contatti">Contatti</a>
            </div>
        </div>
    </nav>

    <main class="evento-page">
        <!-- Loading state -->
        <div id="loading" class="loading-container">
            <div class="loading-content">
                <div class="spinner"></div>
                <h2>Caricamento evento...</h2>
                <p>Stiamo recuperando i dettagli dell'evento</p>
            </div>
        </div>

        <!-- Error state -->
        <div id="error" class="error-container" style="display: none;">
            <div class="error-content">
                <span class="material-icons error-icon">error_outline</span>
                <h2>Evento non trovato</h2>
                <p>L'evento che stai cercando non esiste o √® stato rimosso.</p>
                <a href="../" class="btn-primary">Torna alla Home</a>
            </div>
        </div>

        <!-- Evento content -->
        <div id="evento-content" class="evento-container" style="display: none;">
            <!-- Header evento -->
            <div class="evento-header">
                <div class="container">
                    <div class="evento-image-container">
                        <img id="evento-image" src="" alt="" class="evento-image">
                        <div class="evento-overlay">
                            <div class="evento-badge" id="evento-badge">
                                <span class="material-icons">event</span>
                                <span>Evento</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="evento-info">
                        <h1 id="evento-titolo" class="evento-title"></h1>
                        <div class="evento-meta">
                            <div class="meta-item">
                                <span class="material-icons">calendar_today</span>
                                <span id="evento-data"></span>
                            </div>
                            <div class="meta-item">
                                <span class="material-icons">access_time</span>
                                <span id="evento-ora"></span>
                            </div>
                            <div class="meta-item">
                                <span class="material-icons">location_on</span>
                                <span id="evento-luogo"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evento details -->
            <div class="evento-details">
                <div class="container">
                    <div class="details-grid">
                        <div class="details-main">
                            <section class="description-section">
                                <h2>Descrizione</h2>
                                <div id="evento-descrizione" class="evento-description"></div>
                            </section>
                            
                            <section class="organizzatore-section">
                                <h2>Organizzatore</h2>
                                <div id="evento-organizzatore" class="organizzatore-info">
                                    <!-- Popolato da JavaScript -->
                                </div>
                            </section>
                        </div>
                        
                        <div class="details-sidebar">
                            <!-- App prompt -->
                            <div class="app-prompt-card">
                                <div class="app-prompt-header">
                                    <span class="material-icons">phone_android</span>
                                    <h3>Hai l'app Ibidem?</h3>
                                </div>
                                <p>Scarica l'app per partecipare all'evento e ricevere notifiche!</p>
                                
                                <!-- Try to open app button -->
                                <button id="open-app-btn" class="btn-open-app" onclick="tryOpenApp()">
                                    <span class="material-icons">launch</span>
                                    Apri nell'App
                                </button>
                                
                                <!-- Download buttons -->
                                <div class="download-buttons-small">
                                    <a href="https://play.google.com/store/apps/details?id=com.ibidem.app" class="btn-download-small" target="_blank">
                                        <img src="../images/google-play.png" alt="Google Play">
                                    </a>
                                    <a href="https://apps.apple.com/app/ibidem/id123456789" class="btn-download-small" target="_blank">
                                        <img src="../images/app-store.png" alt="App Store">
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Share card -->
                            <div class="share-card">
                                <h3>Condividi evento</h3>
                                <div class="share-buttons">
                                    <button onclick="shareEvent('whatsapp')" class="share-btn whatsapp">
                                        <span class="material-icons">share</span>
                                        WhatsApp
                                    </button>
                                    <button onclick="shareEvent('telegram')" class="share-btn telegram">
                                        <span class="material-icons">share</span>
                                        Telegram
                                    </button>
                                    <button onclick="shareEvent('copy')" class="share-btn copy">
                                        <span class="material-icons">content_copy</span>
                                        Copia Link
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        let currentEvento = null;
        
        // Estrai ID evento dall'URL
        const urlParams = new URLSearchParams(window.location.search);
        const eventoId = urlParams.get('id') || 
                        window.location.pathname.split('/').filter(p => p && p !== 'evento').pop() ||
                        window.location.hash.replace('#', '');
        
        console.log('üîç Evento ID:', eventoId);
        
        // Carica dettagli evento
        if (eventoId) {
            loadEventoDetails(eventoId);
        } else {
            showError();
        }
        
        // Funzione per aprire app
        function tryOpenApp() {
            if (!eventoId) return;
            
            const appUrl = `ibidem://evento/${eventoId}`;
            const storeUrl = 'https://play.google.com/store/apps/details?id=com.ibidem.app';
            
            console.log('üöÄ Tentativo apertura app:', appUrl);
            
            // Tenta apertura app
            window.location.href = appUrl;
            
            // Fallback su store dopo 2 secondi se app non si apre
            setTimeout(() => {
                if (document.visibilityState === 'visible') {
                    window.open(storeUrl, '_blank');
                }
            }, 2000);
        }
        
        // Carica dettagli evento
        async function loadEventoDetails(id) {
            try {
                // TODO: Sostituire con vera chiamata API Supabase
                // const response = await fetch(`https://your-supabase.supabase.co/rest/v1/EVENTI?id=eq.${id}`);
                // const [evento] = await response.json();
                
                // Per ora, dati mock basati sull'ID
                const mockEvents = {
                    '123': {
                        id: 123,
                        titolo: "Concerto Jazz al Tramonto",
                        descrizione: "Una serata magica con la migliore musica jazz sotto le stelle. Artisti internazionali si esibiranno in un concerto unico che unisce tradizione e innovazione.",
                        data_evento: "2024-01-15",
                        ora_da: "20:00",
                        immagine: "https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=800",
                        LUOGHI: { nome: "Teatro Romano, Milano" },
                        ORGANIZZAZIONI: { denominazione: "Jazz Milano Events" }
                    },
                    '456': {
                        id: 456,
                        titolo: "Sagra della Pizza Napoletana",
                        descrizione: "Tre giorni dedicati alla vera pizza napoletana con maestri pizzaioli da tutta la Campania. Degustazioni, workshop e intrattenimento per tutta la famiglia.",
                        data_evento: "2024-01-20",
                        ora_da: "18:00",
                        immagine: "https://images.unsplash.com/photo-1565299624946-b28f40a0ca4b?w=800",
                        LUOGHI: { nome: "Piazza del Popolo, Roma" },
                        ORGANIZZAZIONI: { denominazione: "Associazione Pizzaioli Romani" }
                    }
                };
                
                const evento = mockEvents[id] || mockEvents['123']; // Fallback al primo evento
                
                if (evento) {
                    currentEvento = evento;
                    populateEventoPage(evento);
                    showEvento();
                } else {
                    showError();
                }
                
            } catch (error) {
                console.error('‚ùå Errore caricamento evento:', error);
                showError();
            }
        }
        
        // Popola la pagina con i dati dell'evento
        function populateEventoPage(evento) {
            // Meta tags
            document.getElementById('page-title').textContent = `${evento.titolo} - Ibidem`;
            document.getElementById('page-description').setAttribute('content', evento.descrizione);
            document.getElementById('og-title').setAttribute('content', evento.titolo);
            document.getElementById('og-description').setAttribute('content', evento.descrizione);
            document.getElementById('og-image').setAttribute('content', evento.immagine || '../images/logo.png');
            document.getElementById('og-url').setAttribute('content', window.location.href);
            
            // Contenuto pagina
            document.getElementById('evento-titolo').textContent = evento.titolo;
            document.getElementById('evento-data').textContent = formatDate(evento.data_evento);
            document.getElementById('evento-ora').textContent = evento.ora_da ? `dalle ${evento.ora_da}` : 'Orario da definire';
            document.getElementById('evento-luogo').textContent = evento.LUOGHI?.nome || 'Luogo da definire';
            document.getElementById('evento-descrizione').textContent = evento.descrizione;
            
            // Immagine
            const imgElement = document.getElementById('evento-image');
            if (evento.immagine) {
                imgElement.src = evento.immagine;
                imgElement.alt = evento.titolo;
            } else {
                imgElement.style.display = 'none';
            }
            
            // Organizzatore
            const orgContainer = document.getElementById('evento-organizzatore');
            if (evento.ORGANIZZAZIONI?.denominazione) {
                orgContainer.innerHTML = `
                    <div class="organizzatore-card">
                        <div class="organizzatore-icon">
                            <span class="material-icons">business</span>
                        </div>
                        <div class="organizzatore-info">
                            <h4>${evento.ORGANIZZAZIONI.denominazione}</h4>
                            <p>Organizzatore dell'evento</p>
                        </div>
                    </div>
                `;
            }
            
            // Badge evento passato
            const now = new Date();
            const eventoDate = new Date(evento.data_evento);
            if (eventoDate < now) {
                const badge = document.getElementById('evento-badge');
                badge.innerHTML = '<span class="material-icons">history</span><span>Evento Passato</span>';
                badge.classList.add('evento-passato');
            }
        }
        
        // Mostra sezione evento
        function showEvento() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('evento-content').style.display = 'block';
        }
        
        // Mostra errore
        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('evento-content').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }
        
        // Formatta data
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                return date.toLocaleDateString('it-IT', options);
            } catch (e) {
                return dateString;
            }
        }
        
        // Condivisione eventi
        function shareEvent(platform) {
            if (!currentEvento) return;
            
            const url = window.location.href;
            const text = `üéâ ${currentEvento.titolo}\n\nüìÖ ${formatDate(currentEvento.data_evento)}\nüìç ${currentEvento.LUOGHI?.nome || ''}\n\n`;
            
            switch (platform) {
                case 'whatsapp':
                    window.open(`https://wa.me/?text=${encodeURIComponent(text + url)}`, '_blank');
                    break;
                case 'telegram':
                    window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`, '_blank');
                    break;
                case 'copy':
                    navigator.clipboard.writeText(url).then(() => {
                        alert('Link copiato negli appunti!');
                    });
                    break;
            }
        }
    </script>
</body>
</html>
