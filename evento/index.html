<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Evento su Ibidem</title>
    
    <!-- Meta tags dinamici -->
    <meta name="description" content="Scopri questo evento su Ibidem" id="page-description">
    <meta property="og:title" content="Evento su Ibidem" id="og-title">
    <meta property="og:description" content="Scopri questo evento su Ibidem" id="og-description">
    <meta property="og:image" content="" id="og-image">
    <meta property="og:url" content="" id="og-url">
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="icon" href="../images/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="../">
                    <img src="../images/logo.png" alt="Ibidem Logo" class="nav-logo">
                    <span>Ibidem</span>
                </a>
            </div>
            <div class="nav-links">
                <a href="../#features">Funzionalit√†</a>
                <a href="../download.html">Download</a>
                <a href="../#contatti">Contatti</a>
            </div>
        </div>
    </nav>

    <main class="evento-page">
        <!-- Loading state -->
        <div id="loading" class="loading-container">
            <div class="loading-content">
                <div class="spinner"></div>
                <h2>Caricamento evento...</h2>
                <p>Stiamo recuperando i dettagli dell'evento dal database</p>
            </div>
        </div>

        <!-- Error state -->
        <div id="error" class="error-container" style="display: none;">
            <div class="error-content">
                <span class="material-icons error-icon">error_outline</span>
                <h2>Evento non trovato</h2>
                <p>L'evento che stai cercando non esiste o √® stato rimosso dal database.</p>
                <a href="../" class="btn-primary">Torna alla Home</a>
            </div>
        </div>

        <!-- Evento content -->
        <div id="evento-content" class="evento-container" style="display: none;">
            <!-- Header evento -->
            <div class="evento-header">
                <div class="container">
                    <div class="evento-image-container">
                        <img id="evento-image" src="" alt="" class="evento-image">
                        <div class="evento-overlay">
                            <div class="evento-badge" id="evento-badge">
                                <span class="material-icons">event</span>
                                <span>Evento</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="evento-info">
                        <h1 id="evento-titolo" class="evento-title"></h1>
                        <div class="evento-meta">
                            <div class="meta-item">
                                <span class="material-icons">calendar_today</span>
                                <span id="evento-data"></span>
                            </div>
                            <div class="meta-item">
                                <span class="material-icons">access_time</span>
                                <span id="evento-ora"></span>
                            </div>
                            <div class="meta-item">
                                <span class="material-icons">location_on</span>
                                <span id="evento-luogo"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evento details -->
            <div class="evento-details">
                <div class="container">
                    <div class="details-grid">
                        <div class="details-main">
                            <section class="description-section">
                                <h2>Descrizione</h2>
                                <div id="evento-descrizione" class="evento-description"></div>
                            </section>
                            
                            <section class="organizzatore-section">
                                <h2>Organizzatore</h2>
                                <div id="evento-organizzatore" class="organizzatore-info">
                                    <!-- Popolato da JavaScript -->
                                </div>
                            </section>
                        </div>
                        
                        <div class="details-sidebar">
                            <!-- App prompt -->
                            <div class="app-prompt-card">
                                <div class="app-prompt-header">
                                    <span class="material-icons">phone_android</span>
                                    <h3>Hai l'app Ibidem?</h3>
                                </div>
                                <p>Scarica l'app per partecipare all'evento e ricevere notifiche!</p>
                                
                                <!-- Try to open app button -->
                                <button id="open-app-btn" class="btn-open-app" onclick="tryOpenApp()">
                                    <span class="material-icons">launch</span>
                                    Apri nell'App
                                </button>
                                
                                <!-- Download buttons -->
                                <div class="download-buttons-small">
                                    <a href="https://play.google.com/store/apps/details?id=com.ibidem.app" class="btn-download-small" target="_blank">
                                        <img src="../images/google-play.png" alt="Google Play">
                                    </a>
                                    <a href="https://apps.apple.com/app/ibidem/id123456789" class="btn-download-small" target="_blank">
                                        <img src="../images/app-store.png" alt="App Store">
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Share card -->
                            <div class="share-card">
                                <h3>Condividi evento</h3>
                                <div class="share-buttons">
                                    <button onclick="shareEvent('whatsapp')" class="share-btn whatsapp">
                                        <span class="material-icons">share</span>
                                        WhatsApp
                                    </button>
                                    <button onclick="shareEvent('telegram')" class="share-btn telegram">
                                        <span class="material-icons">share</span>
                                        Telegram
                                    </button>
                                    <button onclick="shareEvent('copy')" class="share-btn copy">
                                        <span class="material-icons">content_copy</span>
                                        Copia Link
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- üÜï NUOVO: Carica prima il JavaScript principale con Supabase -->
    <script src="../js/app.js"></script>
    
    <!-- üÜï NUOVO: JavaScript specifico per evento (SEMPLIFICATO) -->
    <script>
        let currentEvento = null;
        
        // Estrai ID evento dall'URL con logica migliorata
        function getEventoId() {
            // Prova diversi metodi per ottenere l'ID
            const urlParams = new URLSearchParams(window.location.search);
            let eventoId = urlParams.get('id');
            
            if (!eventoId) {
                // Prova dal path: /evento/123
                const pathSegments = window.location.pathname.split('/').filter(p => p);
                const eventoIndex = pathSegments.indexOf('evento');
                if (eventoIndex !== -1 && eventoIndex + 1 < pathSegments.length) {
                    eventoId = pathSegments[eventoIndex + 1];
                }
            }
            
            if (!eventoId) {
                // Prova dall'hash: #123
                eventoId = window.location.hash.replace('#', '');
            }
            
            return eventoId;
        }
        
        const eventoId = getEventoId();
        console.log('üéØ Evento ID estratto:', eventoId);
        
        // Carica dettagli evento quando il DOM √® pronto
        document.addEventListener('DOMContentLoaded', async function() {
            if (eventoId && eventoId !== '') {
                console.log(`üöÄ Inizio caricamento evento ID: ${eventoId}`);
                await loadEventoDetails(eventoId);
            } else {
                console.log('‚ùå Nessun ID evento trovato nell\'URL');
                showError();
            }
        });
        
        // üÜï NUOVA: Funzione per aprire app (semplificata)
        function tryOpenApp() {
            if (!eventoId) {
                console.log('‚ùå Nessun evento ID disponibile per aprire app');
                return;
            }
            
            const appUrl = `ibidem://evento/${eventoId}`;
            const storeUrl = 'https://play.google.com/store/apps/details?id=com.ibidem.app';
            
            console.log('üöÄ Tentativo apertura app:', appUrl);
            
            // Mostra feedback immediato
            const button = document.getElementById('open-app-btn');
            if (button) {
                const originalText = button.innerHTML;
                button.innerHTML = '<span class="material-icons">hourglass_empty</span> Apertura...';
                button.disabled = true;
                
                // Ripristina il bottone dopo 3 secondi
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 3000);
            }
            
            // Tenta apertura app
            window.location.href = appUrl;
            
            // Fallback su store dopo 2 secondi se app non si apre
            setTimeout(() => {
                if (document.visibilityState === 'visible') {
                    window.open(storeUrl, '_blank');
                }
            }, 2000);
        }
        
        // üÜï NUOVA: Funzioni di condivisione evento
        function shareEvent(platform) {
            if (!currentEvento) {
                console.log('‚ùå Nessun evento caricato per condivisione');
                return;
            }
            
            const url = window.location.href;
            const titolo = currentEvento.titolo || 'Evento su Ibidem';
            const data = currentEvento.data_evento ? formatDate(currentEvento.data_evento) : '';
            const luogo = currentEvento.LUOGHI?.nome || '';
            
            let text = `üéâ ${titolo}`;
            if (data) text += `\n\nüìÖ ${data}`;
            if (luogo) text += `\nüìç ${luogo}`;
            text += `\n\nScopri di pi√π su Ibidem!`;
            
            console.log(`üì± Condivisione su ${platform}:`, { url, text });
            
            switch (platform) {
                case 'whatsapp':
                    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text + '\n\n' + url)}`;
                    window.open(whatsappUrl, '_blank');
                    break;
                    
                case 'telegram':
                    const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
                    window.open(telegramUrl, '_blank');
                    break;
                    
                case 'copy':
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(url).then(() => {
                            showToast('‚úÖ Link copiato negli appunti!', 'success');
                        }).catch(() => {
                            showToast('‚ùå Errore copia link', 'error');
                        });
                    } else {
                        // Fallback per browser pi√π vecchi
                        const textArea = document.createElement('textarea');
                        textArea.value = url;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        try {
                            if (document.execCommand('copy')) {
                                showToast('‚úÖ Link copiato negli appunti!', 'success');
                            } else {
                                showToast('‚ùå Errore copia link', 'error');
                            }
                        } catch (err) {
                            showToast('‚ùå Errore copia link', 'error');
                        }
                        
                        textArea.remove();
                    }
                    break;
                    
                default:
                    console.log('‚ùå Piattaforma di condivisione non riconosciuta:', platform);
            }
        }
        
        // üÜï NUOVA: Mostra stato dell'evento
        function showEvento() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('evento-content').style.display = 'block';
            
            console.log('‚úÖ Evento mostrato con successo');
        }
        
        // üÜï NUOVA: Mostra errore
        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('evento-content').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            
            console.log('‚ùå Mostrato stato di errore');
        }
        
        // üÜï NUOVA: Toast notification semplice
        function showToast(message, type = 'info') {
            // Crea toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 500;
                max-width: 300px;
                word-wrap: break-word;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            
            // Aggiungi CSS animation se non esiste
            if (!document.querySelector('#toast-animations')) {
                const style = document.createElement('style');
                style.id = 'toast-animations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            // Rimuovi dopo 3 secondi
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 3000);
        }
        
        // Utility: formatta data (copia della funzione principale)
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                return date.toLocaleDateString('it-IT', options);
            } catch (e) {
                console.error('‚ùå Errore formattazione data:', e);
                return dateString;
            }
        }
        
        // üìä Debug info
        console.log('üîß Pagina evento inizializzata');
        console.log('üìç URL corrente:', window.location.href);
        console.log('üÜî ID evento estratto:', eventoId);
        console.log('üåê User Agent:', navigator.userAgent);
    </script>
</body>
</html>
